worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /usr/local/openresty/nginx/logs/nginx.pid;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}

http {
    include conf.d/http-base.conf;

    # API key validation map
    # Keys are validated by matching the path prefix /rpc/<key>
    # {{API_KEYS}} should be replaced with entries like:
    #     ~^/rpc/abc123  1;
    #     ~^/rpc/xyz789  1;
    map $uri $valid_api_key {
        {{API_KEYS}}
        default 0;
    }

    # HTTP server for public domain(s)
    server {
        listen 80;
        server_name {{PUBLIC_DOMAIN_NAMES}};

        location /health {
            access_log off;
            default_type text/plain;
            return 200 "healthy\n";
        }

        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    # HTTP server for secure domain(s)
    server {
        listen 80;
        server_name {{SECURE_DOMAIN_NAMES}};

        location /health {
            access_log off;
            default_type text/plain;
            return 200 "healthy\n";
        }

        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    # HTTPS server for public domain(s) - no auth required
    server {
        listen 443 ssl;
        http2 on;
        server_name {{PUBLIC_DOMAIN_NAMES}};

        include conf.d/ssl.conf;
        include conf.d/security-headers.conf;

        location /health {
            access_log off;
            default_type text/plain;
            return 200 "healthy\n";
        }

        include conf.d/proxy-location.conf;
    }

    # HTTPS server for secure domain(s) - API key required in path
    # Usage: https://secure.example.com/rpc/<api_key>
    server {
        listen 443 ssl;
        http2 on;
        server_name {{SECURE_DOMAIN_NAMES}};

        include conf.d/ssl.conf;
        include conf.d/security-headers.conf;

        location /health {
            access_log off;
            default_type text/plain;
            return 200 "healthy\n";
        }

        # API key protected RPC endpoint
        location ~ ^/rpc/([a-zA-Z0-9_-]+)(/.*)?$ {
            if ($valid_api_key = 0) {
                return 401 '{"error": "Invalid API key"}\n';
            }

            # Strip the API key from the path, default to / if no trailing path
            set $backend_path $2;
            if ($backend_path = "") {
                set $backend_path /;
            }

            rewrite ^/rpc/[a-zA-Z0-9_-]+(/.*)?$ $backend_path break;
            include conf.d/proxy-location.conf;
        }

        # Reject requests without API key
        location / {
            return 401 '{"error": "API key required. Use /rpc/<api_key>"}\n';
        }
    }
}
