worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /usr/local/openresty/nginx/logs/nginx.pid;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}

http {
    include conf.d/http-base.conf;

    server {
        listen 80;
        server_name {{DOMAIN_NAME}};

        include conf.d/health-acme.conf;

        # Redirect all other HTTP traffic to HTTPS
        location / {
            return 301 https://$server_name$request_uri;
        }
    }

    server {
        listen 443 ssl;
        http2 on;
        server_name {{DOMAIN_NAME}};

        include conf.d/ssl.conf;
        include conf.d/security-headers.conf;

        # Health check endpoint (no ACME needed on HTTPS)
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        include conf.d/proxy-location.conf;
    }
}
