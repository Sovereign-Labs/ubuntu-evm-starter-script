# Common HTTP-level configuration
# Included in the http {} block of main nginx configs

# Define IP addresses exempt from rate limiting
# See https://blog.nginx.org/blog/rate-limiting-nginx
geo $rate_limit_override {
    default 0;
    204.48.36.211 1;  # Exempt this IP from rate limiting
    186.233.184.99 1;  # Exempt this IP from rate limiting
    69.67.150.199 1;  # Exempt this IP from rate limiting
    186.233.184.211 1;  # Exempt this IP from rate limiting
    50.19.142.232 1;  # Exempt this IP from rate limiting
    13.42.134.239 1;  # Exempt this IP from rate limiting
    13.251.150.237 1;  # Exempt this IP from rate limiting
    13.159.176.66 1;  # Exempt this IP from rate limiting
    3.229.31.102 1;  # Exempt this IP from rate limiting
    13.42.182.54 1;  # Exempt this IP from rate limiting
    54.169.32.9  1;  # Exempt this IP from rate limiting
    13.112.174.175 1;  # Exempt this IP from rate limiting
    146.75.245.79 1;  # Exempt this IP from rate limiting
    # RATE_LIMIT_PLACEHOLDER
}

# Map to set the rate limit key (empty string bypasses rate limiting)
map $rate_limit_override $rate_limit_key {
    0 $binary_remote_addr;
    1 "";
}

include /usr/local/openresty/nginx/conf/mime.types;
default_type application/json;

log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                '$status $body_bytes_sent "$http_referer" '
                '"$http_user_agent" "$http_x_forwarded_for" '
                'rt=$request_time backend=$upstream_addr';

access_log /var/log/nginx/access.log main;

sendfile on;
tcp_nopush on;
tcp_nodelay on;
keepalive_timeout 65;
keepalive_requests 1000;

# Shared memory for caching backend IPs
lua_shared_dict backend_cache 1m;

# Initialize background refresh of backend IPs
init_worker_by_lua_block {
    local function refresh_backends()
        -- TODO: Query Postgres for current leader/follower IPs
        -- For now, use static values
        ngx.shared.backend_cache:set("leader", "{{ROLLUP_LEADER_IP}}:12346")
        ngx.shared.backend_cache:set("follower", "{{ROLLUP_FOLLOWER_IP}}:12346")

        -- Schedule next refresh
        local ok, err = ngx.timer.at(0.2, refresh_backends)
        if not ok then
            ngx.log(ngx.ERR, "failed to schedule backend refresh: ", err)
        end
    end

    -- Start the refresh timer
    ngx.timer.at(0, refresh_backends)
}

# Gzip compression
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types
    application/json
    text/plain
    text/css
    application/javascript
    text/xml
    application/xml
    application/xml+rss
    text/javascript;

# Buffer sizes - limit request body size
client_body_buffer_size 128k;    # Buffer small requests in memory
client_max_body_size 1m;        # Reject requests > 1MB
client_header_buffer_size 1k;
large_client_header_buffers 4 4k;

# DNS resolver for dynamic proxy_pass - AWS VPC DNS: https://docs.aws.amazon.com/vpc/latest/userguide/AmazonDNS-concepts.html
resolver 169.254.169.253 valid=10s;

# Proxy settings
proxy_buffering on;
proxy_buffer_size 64k;
proxy_buffers 8 64k;
proxy_busy_buffers_size 128k;
proxy_http_version 1.1;

# Rate limiting zone - 100 requests per second per IP
# Uses $rate_limit_key which is empty for exempted IPs (defined in httpBaseConfig)
limit_req_zone $rate_limit_key zone=global_limit:10m rate=100r/s;

# WebSocket connection upgrade map
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}
