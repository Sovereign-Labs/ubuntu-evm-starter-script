# API key protected RPC locations
# Included in server {} blocks that require authentication
# Requires $valid_api_key map from http-base.conf

# API key protected RPC endpoint
location ~ ^/rpc/([a-zA-Z0-9_-]+)(/.*)?$ {
    if ($valid_api_key = 0) {
        return 401 '{"error": "Invalid API key"}\n';
    }

    # Strip the API key from the path, default to / if no trailing path
    set $backend_path $2;
    if ($backend_path = "") {
        set $backend_path /;
    }

    rewrite ^/rpc/[a-zA-Z0-9_-]+(/.*)?$ $backend_path break;
    include conf.d/proxy-upstream.conf;
}

# Reject requests without API key
location / {
    return 401 '{"error": "API key required. Use /rpc/<api_key>"}\n';
}
