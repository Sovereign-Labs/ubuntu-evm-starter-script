# API key protected RPC locations
# Included in server {} blocks that require authentication
# Requires $valid_api_key map, failed_auth_limit and backend_cache shared dicts from http-base.conf

# API key protected RPC endpoint - only allows /rpc/<key> or /rpc/<key>/
location ~ ^/rpc/([a-zA-Z0-9_-]+)/?$ {
    # Apply conditional rate limiting (same as public endpoints)
    limit_req zone=global_limit burst=50 nodelay;
    limit_req_status 429;

    set $backend '';

    # API key rate limiting + backend selection
    access_by_lua_block {
        -- Rate limit failed API key attempts
        local fail_cache = ngx.shared.failed_auth_limit
        local fail_key = "fail:" .. ngx.var.binary_remote_addr
        local fail_count = fail_cache:get(fail_key) or 0

        -- Check rate limit FIRST, before revealing key validity
        if fail_count > 10 then
            ngx.status = 429
            ngx.header["Content-Type"] = "application/json"
            ngx.say('{"error": "Too many invalid API key attempts"}')
            return ngx.exit(429)
        end

        -- Only increment counter for invalid keys
        if ngx.var.valid_api_key == "0" then
            fail_cache:incr(fail_key, 1, 0, 5)  -- increment, init=0, ttl=5s

            ngx.status = 401
            ngx.header["Content-Type"] = "application/json"
            ngx.say('{"error": "Invalid API key"}')
            return ngx.exit(401)
        end

        -- Valid key and under rate limit, select backend (always /rpc)
        require("backend-select").select("/rpc")
    }

    rewrite ^ /rpc break;

    include conf.d/proxy-settings.conf;
}

# Reject requests without API key
location / {
    access_by_lua_block {
        local cache = ngx.shared.failed_auth_limit
        local key = "nokey:" .. ngx.var.binary_remote_addr
        local count = cache:get(key) or 0

        if count > 10 then
            ngx.status = 429
            ngx.header["Content-Type"] = "application/json"
            ngx.say('{"error": "Too many requests without API key"}')
            return ngx.exit(429)
        end

        cache:incr(key, 1, 0, 5)

        ngx.status = 401
        ngx.header["Content-Type"] = "application/json"
        ngx.say('{"error": "API key required. Use /rpc/<api_key>"}')
        return ngx.exit(401)
    }
}
