# API key protected RPC locations
# Included in server {} blocks that require authentication
# Requires $valid_api_key map and failed_auth_limit shared dict from http-base.conf

# API key protected RPC endpoint
location ~ ^/rpc/([a-zA-Z0-9_-]+)(/.*)?$ {
    # Rate limit attempts to guess API keys to 10 rps
    access_by_lua_block {
        local cache = ngx.shared.failed_auth_limit
        local key = "fail:" .. ngx.var.binary_remote_addr
        local count = cache:get(key) or 0

        -- Check rate limit FIRST, before revealing key validity
        if count > 10 then
            ngx.status = 429
            ngx.header["Content-Type"] = "application/json"
            ngx.say('{"error": "Too many invalid API key attempts"}')
            return ngx.exit(429)
        end

        -- Only increment counter for invalid keys
        if ngx.var.valid_api_key == "0" then
            cache:incr(key, 1, 0, 5)  -- increment, init=0, ttl=5s

            ngx.status = 401
            ngx.header["Content-Type"] = "application/json"
            ngx.say('{"error": "Invalid API key"}')
            return ngx.exit(401)
        end

        -- Valid key and under rate limit, continue to proxy
    }

    # Strip the API key from the path, default to / if no trailing path
    set $backend_path $2;
    if ($backend_path = "") {
        set $backend_path /;
    }

    rewrite ^/rpc/[a-zA-Z0-9_-]+(/.*)?$ $backend_path break;
    include conf.d/proxy-upstream.conf;
}

# Reject requests without API key
location / {
    access_by_lua_block {
        local cache = ngx.shared.failed_auth_limit
        local key = "nokey:" .. ngx.var.binary_remote_addr
        local count = cache:get(key) or 0

        if count > 10 then
            ngx.status = 429
            ngx.header["Content-Type"] = "application/json"
            ngx.say('{"error": "Too many requests without API key"}')
            return ngx.exit(429)
        end

        cache:incr(key, 1, 0, 5)

        ngx.status = 401
        ngx.header["Content-Type"] = "application/json"
        ngx.say('{"error": "API key required. Use /rpc/<api_key>"}')
        return ngx.exit(401)
    }
}
